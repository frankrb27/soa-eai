<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:camel="http://camel.apache.org/schema/spring" xmlns:cxf="http://camel.apache.org/schema/cxf"
	xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
       http://camel.apache.org/schema/cxf http://camel.apache.org/schema/cxf/camel-cxf.xsd">


	<import resource="mq-conf.xml" />

	<!--bean class="com.rabbitmq.client.ConnectionFactory" id="customConnectionFactory"> 
		<property name="host" value="localhost" /> <property name="port" value="5672" 
		/> <property name="username" value="guest" /> <property name="password" value="guest" 
		/> </bean -->

	<!-- INI : SOAP FOR BPEL -->
	<cxf:cxfEndpoint id="cxfAlert" address="/ws/alert-on-air"
		endpointName="tns:AlertOnAirEndpoint" serviceName="tns:AlertOnAirEndpointService"
		wsdlURL="deploy/wsdl/alert-on-air.wsdl" serviceClass="co.com.ws.alert_on_air.AlertOnAirEndpoint"
		xmlns:tns="http://alert-on-air.ws.com.co" />

	<cxf:cxfEndpoint id="cxfShopping" address="/ws/on-air-shopping"
		endpointName="tns:OnAirShoppingEndpoint" serviceName="tns:OnAirShoppingEndpointService"
		wsdlURL="deploy/wsdl/on-air-shopping.wsdl" serviceClass="co.com.ws.on_air_shopping.OnAirShoppingEndpoint"
		xmlns:tns="http://on-air-shopping.ws.com.co" />

	<cxf:cxfEndpoint id="cxfCancel" address="/ws/cancel-flight"
		endpointName="tns:CancelFlightEndpoint" serviceName="tns:CancelFlightEndpointService"
		wsdlURL="deploy/wsdl/cancel-flight.wsdl" serviceClass="co.com.ws.cancel_flight.CancelFlightEndpoint"
		xmlns:tns="http://cancel-flight.ws.com.co" />

	<cxf:cxfEndpoint id="cxfMaintenance" address="/ws/maintenance-planner"
		endpointName="tns:MaintenancePlannerEndpoint" serviceName="tns:MaintenancePlannerEndpointService"
		wsdlURL="deploy/wsdl/maintenance-planner.wsdl" serviceClass="co.com.ws.maintenance_planner.MaintenancePlannerEndpoint"
		xmlns:tns="http://maintenance-planner.ws.com.co" />

	<bean id="processAlert" class="co.com.ws.processor.AlertOnAirProcessor" />
	<bean id="processShopping" class="co.com.ws.processor.OnAirShoppingProcessor" />
	<bean id="processCancel" class="co.com.ws.processor.CancelFlightProcessor" />
	<bean id="processMaintenance" class="co.com.ws.processor.MaintenancePlannerProcessor" />
	<!-- TRANSFORMERS -->
	<bean id="shoppingTransform" class="co.com.core.transformer.ShoppingTransformer" />

	<camelContext id="domainEvents" xmlns="http://camel.apache.org/schema/spring">
		<camel:route id="createAlert">
			<camel:from uri="cxf:bean:cxfAlert" />
			<camel:convertBodyTo type="co.com.ws.alert_on_air.AlertOnAirRequest" />
			<camel:to uri="xslt:transformation/alert-on-air.xsl" />
			<camel:inOnly uri="activemq:queue:FLIGHTS.GUARD.REQUEST.QUEUE" />
			<camel:log
				message="[JBossFuse - createAlert] ---------------> Send message to Flight Guards QUEUE" />
			<process ref="processAlert" />
		</camel:route>

		<camel:route id="createShopping">
			<camel:from uri="cxf:bean:cxfShopping" />
			<process ref="shoppingTransform" />
			<camel:log
				message="[JBossFuse - createShopping] ---------------> File generated" />
			<camel:to
				uri="file:/home/frank/target-system/blizard?fileName=output-${date:now:yyyyMMdd hhmmss}.txt" />
			<process ref="processShopping" />
		</camel:route>

		<camel:route id="cancelFlight">
			<camel:from uri="cxf:bean:cxfCancel" />
			<process ref="processCancel" />
		</camel:route>

		<camel:route id="sendMaintenance">
			<camel:from uri="cxf:bean:cxfMaintenance" />
			<camel:convertBodyTo type="co.com.ws.maintenance_planner.MaintenancePlannerRequest" />
			<camel:to uri="xslt:transformation/maintenance-planner.xsl" />
			<camel:log
				message="[JBossFuse - sendMaintenance] ---------------> Send XMl message" />
			<camel:to
				uri="file:/home/frank/target-system/maintenance?fileName=output-${date:now:yyyyMMdd hhmmss}.txt" />
			<process ref="processMaintenance" />
		</camel:route>
	</camelContext>
	<!-- FIN : SOAP FOR BPEL -->

	<camel:camelContext xmlns="http://camel.apache.org/schema/spring"
		xmlns:tns="http://aerolineas-latinoamericanas/contract/messages">

		<camel:dataFormats>
			<camel:jaxb id="jaxb" contextPath="co.com.canonical.flights"
				fragment="true" partClass="co.com.canonical.flights.AircratlineMessage" />
		</camel:dataFormats>

		<camel:route id="aircraft-line-integration">
			<camel:from uri="activemq:queue:AIRCRAFT.LINE.BRIDGE.TOPIC" />
			<!--camel:from uri="rabbitmq://localhost:5672/aircraft-suscription?connectionFactory=#customConnectionFactory&amp;autoDelete=false&amp;queue=AIRCRAFT.LINE.BRIDGE.TOPIC&amp;routingKey=soa-eai" 
				/ -->
			<camel:split>
				<camel:xpath>/tns:aircratline-message</camel:xpath>
				<convertBodyTo type="co.com.canonical.flights.AircratlineMessage" />
				<camel:unmarshal ref="jaxb" />
				<camel:to uri="seda:leg-integration" />
			</camel:split>
		</camel:route>

		<camel:route id="leg-integration">
			<camel:from uri="seda:leg-integration" />
			<camel:log message="[JBossFuse] ---------------> Active JBossFuse" />
			<camel:multicast>
				<camel:choice>
					<camel:when>
						<!-- BLIZARD -->
						<camel:xpath>count(//tns:flight-leg/tns:domain-events-info/tns:on-air-shopping)>0
						</camel:xpath>
						<camel:process ref="shoppingTransform" />
						<camel:log message="[JBossFuse] ---------------> On Air Shopping" />
						<camel:to
							uri="file:/home/frank/target-system/blizard?fileName=output-${date:now:yyyyMMdd hhmmss}.txt" />
						<camel:log
							message="[JBossFuse] ---------------> Send file to BLIZARD SYSTEM" />
					</camel:when>
				</camel:choice>
				<camel:choice>
					<camel:when>
						<!-- FLIGHT GUARDS -->
						<camel:xpath>count(//tns:flight-leg/tns:domain-events-info/tns:alert-on-air)>0
						</camel:xpath>
						<camel:split>
							<camel:xpath>//tns:flight-leg/tns:domain-events-info/tns:alert-on-air
							</camel:xpath>
							<camel:to uri="xslt:transformation/alert-on-air.xsl" />
							<camel:log message="[JBossFuse] ---------------> On Air Alert" />
							<!-- FLIGHTS.GUARD.REQUEST.QUEUE -->
							<camel:to uri="activemq:queue:FLIGHTS.GUARD.REQUEST.QUEUE" />
							<camel:log
								message="[JBossFuse] ---------------> Send message to Flight Guards QUEUE" />
						</camel:split>
					</camel:when>
				</camel:choice>
			</camel:multicast>
		</camel:route>
	</camel:camelContext>
</beans>