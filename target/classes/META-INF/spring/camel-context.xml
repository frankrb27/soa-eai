<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:camel="http://camel.apache.org/schema/spring"
	xsi:schemaLocation="
http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">


	<import resource="mq-conf.xml" />
	<bean id="myFileProcessor" class="co.com.core.transformer.ShoppingTransformer" />

	<!--bean class="com.rabbitmq.client.ConnectionFactory" id="customConnectionFactory"> 
		<property name="host" value="localhost" /> <property name="port" value="5672" 
		/> <property name="username" value="guest" /> <property name="password" value="guest" 
		/> </bean -->

	<camel:camelContext xmlns="http://camel.apache.org/schema/spring"
		xmlns:tns="http://aerolineas-latinoamericanas/contract/messages">

		<camel:dataFormats>
			<camel:jaxb id="jaxb" contextPath="co.com.canonical.flights"
				fragment="true" partClass="co.com.canonical.flights.AircratlineMessage" />
		</camel:dataFormats>

		<camel:route id="aircraft-line-integration">
			<camel:from uri="activemq:queue:AIRCRAFT.LINE.BRIDGE.TOPIC" />
			<!--camel:from uri="rabbitmq://localhost:5672/aircraft-suscription?connectionFactory=#customConnectionFactory&amp;autoDelete=false&amp;queue=AIRCRAFT.LINE.BRIDGE.TOPIC&amp;routingKey=soa-eai" 
				/ -->
			<camel:split>
				<camel:xpath>/tns:aircratline-message</camel:xpath>
				<convertBodyTo type="co.com.canonical.flights.AircratlineMessage"/>
				<camel:unmarshal ref="jaxb" />
				<camel:to uri="seda:leg-integration" />
			</camel:split>
		</camel:route>

		<camel:route id="leg-integration">
			<camel:from uri="seda:leg-integration" />
			<camel:log message="[JBossFuse] ---------------> Active JBossFuse" />
			<camel:multicast>
				<camel:choice>
					<camel:when>
						<!-- BLIZARD -->
						<camel:xpath>count(//tns:flight-leg/tns:domain-events-info/tns:on-air-shopping)>0</camel:xpath>
						<camel:process ref="myFileProcessor" />
						<camel:log message="[JBossFuse] ---------------> On Air Shopping" />
						<camel:to
							uri="file:/home/frank/target-system/blizard?fileName=output-${date:now:yyyyMMdd hhmmss}.txt" />
						<camel:log
							message="[JBossFuse] ---------------> Send file to BLIZARD SYSTEM" />
					</camel:when>
				</camel:choice>
				<camel:choice>
					<camel:when>
						<!-- FLIGHT GUARDS -->
						<camel:xpath>count(//tns:flight-leg/tns:domain-events-info/tns:alert-on-air)>0</camel:xpath>
						<camel:split>
							<camel:xpath>//tns:flight-leg/tns:domain-events-info/tns:alert-on-air</camel:xpath>
							<camel:to uri="xslt:transformation/alert-on-air.xsl" />
							<camel:log message="[JBossFuse] ---------------> On Air Alert" />
							<!-- FLIGHTS.GUARD.REQUEST.QUEUE -->
							<camel:to uri="activemq:queue:FLIGHTS.GUARD.REQUEST.QUEUE" />
							<camel:log
								message="[JBossFuse] ---------------> Send message to Flight Guards QUEUE" />
						</camel:split>
					</camel:when>
				</camel:choice>
			</camel:multicast>
		</camel:route>
	</camel:camelContext>
</beans>